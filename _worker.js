import{connect}from"cloudflare:sockets";let fakeUserID,fakeHostName,userID="",proxyIP="",sub="",subConverter="SUBAPI.fxxk.dedyn.io",subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol="https",subEmoji="true",socks5Address="",parsedSocks5Address={},enableSocks=!1,noTLS="false";const expire=4102329600;let proxyIPs,socks5s,BotToken,ChatID,userIDLow,go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],addresses=[],addressesapi=[],addressesnotls=[],addressesnotlsapi=[],addressescsv=[],DLS=8,remarkIndex=1,FileName=atob("ZWRnZXR1bm5lbA=="),proxyhosts=[],proxyhostsURL="",RproxyIP="false",httpsPorts=["2053","2083","2087","2096","8443"],有效时间=7,更新时间=3,userIDTime="",proxyIPPool=[],path="/?ed=2560";export default{async fetch(e,t,s){try{const s=e.headers.get("User-Agent")||"null",o=s.toLowerCase();if(t.KEY){有效时间=t.TIME||有效时间,更新时间=t.UPTIME||更新时间;const e=await 生成动态UUID(t.KEY);userID=e[0]}else t.UUID&&(userID=t.UUID);if(subEmoji=t.SUBEMOJI||t.EMOJI||subEmoji,"0"==subEmoji&&(subEmoji="false"),!userID)return new Response("请设置你的UUID变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});const n=new Date;n.setHours(0,0,0,0);const r=Math.ceil(n.getTime()/1e3),a=await 双重哈希(`${userID}${r}`);if(fakeUserID=[a.slice(0,8),a.slice(8,12),a.slice(12,16),a.slice(16,20),a.slice(20)].join("-"),fakeHostName=`${a.slice(6,9)}.${a.slice(13,19)}`,proxyIP=t.PROXYIP||proxyIP,proxyIPs=await 整理(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=t.SOCKS5||socks5Address,socks5s=await 整理(socks5Address),socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)],socks5Address=socks5Address.split("//")[1]||socks5Address,t.CFPORTS&&(httpsPorts=await 整理(t.CFPORTS)),sub=t.SUB||sub,subConverter=t.SUBAPI||subConverter,subConverter.includes("http://")?(subConverter=subConverter.split("//")[1],subProtocol="http"):subConverter=subConverter.split("//")[1]||subConverter,subConfig=t.SUBCONFIG||subConfig,socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=t.RPROXYIP||"false",enableSocks=!0}catch(e){let s=e;console.log(s.toString()),RproxyIP=t.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=t.RPROXYIP||!proxyIP?"true":"false";t.ADD&&(addresses=await 整理(t.ADD)),t.ADDAPI&&(addressesapi=await 整理(t.ADDAPI)),t.ADDNOTLS&&(addressesnotls=await 整理(t.ADDNOTLS)),t.ADDNOTLSAPI&&(addressesnotlsapi=await 整理(t.ADDNOTLSAPI)),t.ADDCSV&&(addressescsv=await 整理(t.ADDCSV)),DLS=t.DLS||DLS,remarkIndex=t.CSVREMARK||remarkIndex,BotToken=t.TGTOKEN||BotToken,ChatID=t.TGID||ChatID,t.GO2SOCKS5&&(go2Socks5s=await 整理(t.GO2SOCKS5));const l=e.headers.get("Upgrade"),c=new URL(e.url);if(c.searchParams.has("sub")&&""!==c.searchParams.get("sub")&&(sub=c.searchParams.get("sub")),FileName=t.SUBNAME||FileName,c.searchParams.has("notls")&&(noTLS="true"),l&&"websocket"===l){if(socks5Address=c.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(c.pathname))socks5Address=c.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(c.pathname)||new RegExp("/socks5://","i").test(c.pathname))&&(socks5Address=c.pathname.split("://")[1].split("#")[0],socks5Address.includes("@"))){let e=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(e)&&!e.includes(":")&&(e=atob(e)),socks5Address=`${e}@${socks5Address.split("@")[1]}`}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(e){let t=e;console.log(t.toString()),enableSocks=!1}else enableSocks=!1;return c.searchParams.has("proxyip")?(proxyIP=c.searchParams.get("proxyip"),enableSocks=!1):new RegExp("/proxyip=","i").test(c.pathname)?(proxyIP=c.pathname.toLowerCase().split("/proxyip=")[1],enableSocks=!1):new RegExp("/proxyip.","i").test(c.pathname)&&(proxyIP=`proxyip.${c.pathname.toLowerCase().split("/proxyip.")[1]}`,enableSocks=!1),await 维列斯OverWSHandler(e)}{c.searchParams.has("proxyip")?(path=`/?ed=2560&proxyip=${c.searchParams.get("proxyip")}`,RproxyIP="false"):c.searchParams.has("socks5")?(path=`/?ed=2560&socks5=${c.searchParams.get("socks5")}`,RproxyIP="false"):c.searchParams.has("socks")&&(path=`/?ed=2560&socks5=${c.searchParams.get("socks")}`,RproxyIP="false");const n=c.pathname.toLowerCase();if("/"==n)return t.URL302?Response.redirect(t.URL302,302):t.URL?await 代理URL(t.URL,c):new Response(JSON.stringify(e.cf,null,4),{status:200,headers:{"content-type":"application/json"}});if(n==`/${fakeUserID}`){const s=await 生成配置信息(userID,e.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,c,t);return new Response(`${s}`,{status:200})}if(n==`/${t.KEY}`||n==`/${userID}`){await sendMessage(`#获取订阅 ${FileName}`,e.headers.get("CF-Connecting-IP"),`UA: ${s}</tg-spoiler>\n域名: ${c.hostname}\n<tg-spoiler>入口: ${c.pathname+c.search}</tg-spoiler>`);const n=await 生成配置信息(userID,e.headers.get("Host"),sub,s,RproxyIP,c,t),r=Date.now(),a=new Date(r);a.setHours(0,0,0,0);const l=Math.floor((r-a.getTime())/864e5*24*1099511627776/2);let i=l,d=l,p=26388279066624;return o&&o.includes("mozilla")?new Response(`${n}`,{status:200,headers:{"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${i}; download=${d}; total=${p}; expire=${expire}`}}):new Response(`${n}`,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${i}; download=${d}; total=${p}; expire=${expire}`}})}return t.URL302?Response.redirect(t.URL302,302):t.URL?await 代理URL(t.URL,c):new Response("",{status:404})}}catch(e){return new Response(e.toString())}}};async function 维列斯OverWSHandler(e){const t=new WebSocketPair,[s,o]=Object.values(t);o.accept();let n="",r="";const log=(e,t)=>{console.log(`[${n}:${r}] ${e}`,t||"")},a=e.headers.get("sec-websocket-protocol")||"",l=makeReadableWebSocketStream(o,a,log);let c={value:null},i=!1;return l.pipeTo(new WritableStream({async write(e,t){if(i)return await handleDNSQuery(e,o,null,log);if(c.value){const t=c.value.writable.getWriter();return await t.write(e),void t.releaseLock()}const{hasError:s,message:a,addressType:l,portRemote:d=443,addressRemote:p="",rawDataIndex:u,"维列斯Version":h=new Uint8Array([0,0]),isUDP:f}=process维列斯Header(e,userID);if(n=p,r=`${d}--${Math.random()} ${f?"udp ":"tcp "} `,s)throw new Error(a);if(f){if(53!==d)throw new Error("UDP 代理仅对 DNS（53 端口）启用");i=!0}const S=new Uint8Array([h[0],0]),m=e.slice(u);if(i)return handleDNSQuery(m,o,S,log);log(`处理 TCP 出站连接 ${p}:${d}`),handleTCPOutBound(c,l,p,d,m,o,S,log)},close(){log("readableWebSocketStream 已关闭")},abort(e){log("readableWebSocketStream 已中止",JSON.stringify(e))}})).catch((e=>{log("readableWebSocketStream 管道错误",e)})),new Response(null,{status:101,webSocket:s})}async function handleTCPOutBound(e,t,s,o,n,r,a,l){async function connectAndWrite(s,o,r=!1){l(`connected to ${s}:${o}`);const a=r?await socks5Connect(t,s,o,l):connect({hostname:s,port:o});e.value=a;const c=a.writable.getWriter();return await c.write(n),c.releaseLock(),a}let c=!1;go2Socks5s.length>0&&enableSocks&&(c=await async function(e){return!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some((t=>{let s=t.replace(/\*/g,".*");return new RegExp(`^${s}$`,"i").test(e)}))}(s));let i=await connectAndWrite(s,o,c);remoteSocketToWS(i,r,a,(async function(){enableSocks?i=await connectAndWrite(s,o,!0):(proxyIP&&""!=proxyIP?proxyIP.includes("]:")?(o=proxyIP.split("]:")[1]||o,proxyIP=proxyIP.split("]:")[0]||proxyIP):2===proxyIP.split(":").length&&(o=proxyIP.split(":")[1]||o,proxyIP=proxyIP.split(":")[0]||proxyIP):proxyIP=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),proxyIP.includes(".tp")&&(o=proxyIP.split(".tp")[1].split(".")[0]||o),i=await connectAndWrite(proxyIP||s,o)),i.closed.catch((e=>{console.log("retry tcpSocket closed error",e)})).finally((()=>{safeCloseWebSocket(r)})),remoteSocketToWS(i,r,a,null,l)}),l)}function makeReadableWebSocketStream(e,t,s){let o=!1;return new ReadableStream({start(n){e.addEventListener("message",(e=>{if(o)return;const t=e.data;n.enqueue(t)})),e.addEventListener("close",(()=>{safeCloseWebSocket(e),o||n.close()})),e.addEventListener("error",(e=>{s("WebSocket 服务器发生错误"),n.error(e)}));const{earlyData:r,error:a}=base64ToArrayBuffer(t);a?n.error(a):r&&n.enqueue(r)},pull(e){},cancel(t){o||(s(`可读流被取消，原因是 ${t}`),o=!0,safeCloseWebSocket(e))}})}function process维列斯Header(e,t){if(e.byteLength<24)return{hasError:!0,message:"invalid data"};const s=new Uint8Array(e.slice(0,1));let o=!1,n=!1;if(o=function(e,t,s){const o=stringify(new Uint8Array(s.slice(1,17)));return o===e||o===t}(t,userIDLow,e),!o)return{hasError:!0,message:`invalid user ${new Uint8Array(e.slice(1,17))}`};const r=new Uint8Array(e.slice(17,18))[0],a=new Uint8Array(e.slice(18+r,18+r+1))[0];if(1===a);else{if(2!==a)return{hasError:!0,message:`command ${a} is not support, command 01-tcp,02-udp,03-mux`};n=!0}const l=18+r+1,c=e.slice(l,l+2),i=new DataView(c).getUint16(0);let d=l+2;const p=new Uint8Array(e.slice(d,d+1))[0];let u=0,h=d+1,f="";switch(p){case 1:u=4,f=new Uint8Array(e.slice(h,h+u)).join(".");break;case 2:u=new Uint8Array(e.slice(h,h+1))[0],h+=1,f=(new TextDecoder).decode(e.slice(h,h+u));break;case 3:u=16;const t=new DataView(e.slice(h,h+u)),s=[];for(let e=0;e<8;e++)s.push(t.getUint16(2*e).toString(16));f=s.join(":");break;default:return{hasError:!0,message:`invild addressType is ${p}`}}return f?{hasError:!1,addressRemote:f,addressType:p,portRemote:i,rawDataIndex:h+u,"维列斯Version":s,isUDP:n}:{hasError:!0,message:`addressValue is empty, addressType is ${p}`}}async function remoteSocketToWS(e,t,s,o,n){let r=s,a=!1;await e.readable.pipeTo(new WritableStream({start(){},async write(e,s){a=!0,t.readyState!==WS_READY_STATE_OPEN&&s.error("webSocket.readyState is not open, maybe close"),r?(t.send(await new Blob([r,e]).arrayBuffer()),r=null):t.send(e)},close(){n(`remoteConnection!.readable is close with hasIncomingData is ${a}`)},abort(e){console.error("remoteConnection!.readable abort",e)}})).catch((e=>{console.error("remoteSocketToWS has exception ",e.stack||e),safeCloseWebSocket(t)})),!1===a&&o&&(n("retry"),o())}function base64ToArrayBuffer(e){if(!e)return{error:null};try{e=e.replace(/-/g,"+").replace(/_/g,"/");const t=atob(e);return{earlyData:Uint8Array.from(t,(e=>e.charCodeAt(0))).buffer,error:null}}catch(e){return{error:e}}}function isValidUUID(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}const WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(e){try{e.readyState!==WS_READY_STATE_OPEN&&e.readyState!==WS_READY_STATE_CLOSING||e.close()}catch(e){console.error("safeCloseWebSocket error",e)}}const byteToHex=[];for(let e=0;e<256;++e)byteToHex.push((e+256).toString(16).slice(1));function unsafeStringify(e,t=0){return(byteToHex[e[t+0]]+byteToHex[e[t+1]]+byteToHex[e[t+2]]+byteToHex[e[t+3]]+"-"+byteToHex[e[t+4]]+byteToHex[e[t+5]]+"-"+byteToHex[e[t+6]]+byteToHex[e[t+7]]+"-"+byteToHex[e[t+8]]+byteToHex[e[t+9]]+"-"+byteToHex[e[t+10]]+byteToHex[e[t+11]]+byteToHex[e[t+12]]+byteToHex[e[t+13]]+byteToHex[e[t+14]]+byteToHex[e[t+15]]).toLowerCase()}function stringify(e,t=0){const s=unsafeStringify(e,t);if(!isValidUUID(s))throw TypeError(`生成的 UUID 不符合规范 ${s}`);return s}async function handleDNSQuery(e,t,s,o){try{const n="8.8.4.4",r=53;let a=s;const l=connect({hostname:n,port:r});o(`连接到 ${n}:${r}`);const c=l.writable.getWriter();await c.write(e),c.releaseLock(),await l.readable.pipeTo(new WritableStream({async write(e){t.readyState===WS_READY_STATE_OPEN&&(a?(t.send(await new Blob([a,e]).arrayBuffer()),a=null):t.send(e))},close(){o(`DNS 服务器(${n}) TCP 连接已关闭`)},abort(e){console.error(`DNS 服务器(${n}) TCP 连接异常中断`,e)}}))}catch(e){console.error(`handleDNSQuery 函数发生异常，错误信息: ${e.message}`)}}async function socks5Connect(e,t,s,o){const{username:n,password:r,hostname:a,port:l}=parsedSocks5Address,c=connect({hostname:a,port:l}),i=new Uint8Array([5,2,0,2]),d=c.writable.getWriter();await d.write(i),o("已发送 SOCKS5 问候消息");const p=c.readable.getReader(),u=new TextEncoder;let h,f=(await p.read()).value;if(5!==f[0])return void o(`SOCKS5 服务器版本错误: 收到 ${f[0]}，期望是 5`);if(255===f[1])return void o("服务器不接受任何认证方法");if(2===f[1]){if(o("SOCKS5 服务器需要认证"),!n||!r)return void o("请提供用户名和密码");const e=new Uint8Array([1,n.length,...u.encode(n),r.length,...u.encode(r)]);if(await d.write(e),f=(await p.read()).value,1!==f[0]||0!==f[1])return void o("SOCKS5 服务器认证失败")}switch(e){case 1:h=new Uint8Array([1,...t.split(".").map(Number)]);break;case 2:h=new Uint8Array([3,t.length,...u.encode(t)]);break;case 3:h=new Uint8Array([4,...t.split(":").flatMap((e=>[parseInt(e.slice(0,2),16),parseInt(e.slice(2),16)]))]);break;default:return void o(`无效的地址类型: ${e}`)}const S=new Uint8Array([5,1,0,...h,s>>8,255&s]);if(await d.write(S),o("已发送 SOCKS5 请求"),f=(await p.read()).value,0===f[1])return o("SOCKS5 连接已建立"),d.releaseLock(),p.releaseLock(),c;o("SOCKS5 连接建立失败")}function socks5AddressParser(e){let t,s,o,n,[r,a]=e.split("@").reverse();if(a){const e=a.split(":");if(2!==e.length)throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');[t,s]=e}const l=r.split(":");if(n=Number(l.pop()),isNaN(n))throw new Error("无效的 SOCKS 地址格式：端口号必须是数字");o=l.join(":");if(o.includes(":")&&!/^\[.*\]$/.test(o))throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");return{username:t,password:s,hostname:o,port:n}}function 恢复伪装信息(e,t,s,o){return o&&(e=atob(e)),e=e.replace(new RegExp(fakeUserID,"g"),t).replace(new RegExp(fakeHostName,"g"),s),o&&(e=btoa(e)),e}async function 双重哈希(e){const t=new TextEncoder,s=await crypto.subtle.digest("MD5",t.encode(e)),o=Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join(""),n=await crypto.subtle.digest("MD5",t.encode(o.slice(7,27)));return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("").toLowerCase()}async function 代理URL(e,t){const s=await 整理(e),o=s[Math.floor(Math.random()*s.length)];let n=new URL(o);console.log(n);let r=n.protocol.slice(0,-1)||"https",a=n.hostname,l=n.pathname,c=n.search;"/"==l.charAt(l.length-1)&&(l=l.slice(0,-1)),l+=t.pathname;let i=`${r}://${a}${l}${c}`,d=await fetch(i),p=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return p.headers.set("X-New-URL",i),p}const 啥啥啥_写的这是啥啊=atob("ZG14bGMzTT0=");function 配置信息(e,t){const s=atob(啥啥啥_写的这是啥啊),o=FileName;let n=t,r=443;const a=e,l=t,c=path;let i=["tls",!0];const d=t,p="randomized";t.includes(".workers.dev")&&(n=atob("dmlzYS5jbg=="),r=80,i=["",!1]);return[`${s}://${a}@${n}:${r}?encryp${atob("dGlvbj0=")+"none"}&security=${i[0]}&sni=${d}&fp=${p}&type=ws&host=${l}&path=${encodeURIComponent(c)}#${encodeURIComponent(o)}`,`- type: ${s}\n  name: ${FileName}\n  server: ${n}\n  port: ${r}\n  uuid: ${a}\n  network: ws\n  tls: ${i[1]}\n  udp: false\n  sni: ${d}\n  client-fingerprint: ${p}\n  ws-opts:\n\tpath: "${c}"\n\theaders:\n\t  host: ${l}`]}let subParams=["sub","base64","b64","clash","singbox","sb"];async function 生成配置信息(e,t,s,o,n,r,a){if(s){const h=s.match(/^(?:https?:\/\/)?([^\/]+)/);h&&(s=h[1]);const f=await 整理(s);f.length>1&&(s=f[0])}else if(addresses.length+addressesapi.length+addressesnotls.length+addressesnotlsapi.length+addressescsv.length==0){let S=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"];function generateRandomIPFromCIDR(e){const[t,s]=e.split("/"),o=t.split(".").map(Number),n=32-parseInt(s,10),r=Math.pow(2,n)-1,a=Math.floor(Math.random()*r);return o.map(((e,t)=>t<2?e:2===t?(e&255<<n-8)+(a>>8&255):(e&255<<n)+(255&a))).join(".")}addresses=addresses.concat("127.0.0.1:1234#CFnat"),t.includes(".workers.dev")?addressesnotls=addressesnotls.concat(S.map((e=>generateRandomIPFromCIDR(e)+"#CF随机节点"))):addresses=addresses.concat(S.map((e=>generateRandomIPFromCIDR(e)+"#CF随机节点")))}const l=r.pathname==`/${a.KEY}`?a.KEY:e,c=o.toLowerCase(),i=配置信息(e,t),d=i[0],p=i[1];let u="";if(t.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const m=await fetch(proxyhostsURL);if(!m.ok)return void console.error("获取地址时出错:",m.status,m.statusText);const y=await m.text(),$=y.split("\n").filter((e=>""!==e.trim()));proxyhosts=proxyhosts.concat($)}catch(b){}0!=proxyhosts.length&&(u=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(c.includes("mozilla")&&!subParams.some((e=>r.searchParams.has(e)))){const w=socks5s.map((e=>e.includes("@")?e.split("@")[1]:e.includes("//")?e.split("//")[1]:e));let I="";go2Socks5s.length>0&&enableSocks&&(I=`${decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20")}`,go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?I+=`${decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")}\n`:I+=`\n  ${go2Socks5s.join("\n  ")}\n`);let g="\n";s?(g+=enableSocks?`CFCDN（访问方式）: Socks5\n  ${w.join("\n  ")}\n${I}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP\n  ${proxyIPs.join("\n  ")}\n`:"true"==n?"CFCDN（访问方式）: 自动获取ProxyIP\n":"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！\n",g+=`\nSUB（优选订阅生成器）: ${s}`):(g+=enableSocks?`CFCDN（访问方式）: Socks5\n  ${w.join("\n  ")}\n${I}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP\n  ${proxyIPs.join("\n  ")}\n`:"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！\n",g+="\n您的订阅内容由 内置 addresses/ADD* 参数变量提供\n",addresses.length>0&&(g+=`ADD（TLS优选域名&IP）: \n  ${addresses.join("\n  ")}\n`),addressesnotls.length>0&&(g+=`ADDNOTLS（noTLS优选域名&IP）: \n  ${addressesnotls.join("\n  ")}\n`),addressesapi.length>0&&(g+=`ADDAPI（TLS优选域名&IP 的 API）: \n  ${addressesapi.join("\n  ")}\n`),addressesnotlsapi.length>0&&(g+=`ADDNOTLSAPI（noTLS优选域名&IP 的 API）: \n  ${addressesnotlsapi.join("\n  ")}\n`),addressescsv.length>0&&(g+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: \n  ${addressescsv.join("\n  ")}\n`)),a.KEY&&r.pathname!==`/${a.KEY}`?g="":g+=`\nSUBAPI（订阅转换后端）: ${subProtocol}://${subConverter}\nSUBCONFIG（订阅转换配置文件）: ${subConfig}`;return`\n################################################################\nSubscribe / sub 订阅地址, 支持 Base64、clash-meta、sing-box 订阅格式\n---------------------------------------------------------------\n快速自适应订阅地址:\nhttps://${u}${t}/${l}\nhttps://${u}${t}/${l}?sub\n\nBase64订阅地址:\nhttps://${u}${t}/${l}?b64\nhttps://${u}${t}/${l}?base64\n\nclash订阅地址:\nhttps://${u}${t}/${l}?clash\n\nsingbox订阅地址:\nhttps://${u}${t}/${l}?sb\nhttps://${u}${t}/${l}?singbox\n---------------------------------------------------------------\n################################################################\n${FileName} 配置信息\n---------------------------------------------------------------\n${l!=e?`TOKEN: ${l}\nUUIDNow: ${e}\nUUIDLow: ${userIDLow}\n${userIDTime}TIME（动态UUID有效时间）: ${有效时间} 天\nUPTIME（动态UUID更新时间）: ${更新时间} 时（北京时间）\n\n`:`${userIDTime}`}HOST: ${t}\nUUID: ${e}\nFKID: ${fakeUserID}\nUA: ${o}\n${g}\n---------------------------------------------------------------\n################################################################\nv2ray\n---------------------------------------------------------------\n${d}\n---------------------------------------------------------------\n################################################################\nclash-meta\n---------------------------------------------------------------\n${p}\n---------------------------------------------------------------\n################################################################\n${decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhCmh0dHBzJTNBJTJGJTJGdC5tZSUyRkNNTGl1c3NzcwotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0KZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISEKaHR0cHMlM0ElMkYlMkZnaXRodWIuY29tJTJGY21saXUlMkZlZGdldHVubmVsCi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQolMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjM="))}\n`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";let M=[],x=[],k=[],P=[];t.includes(".workers.dev")?(noTLS="true",fakeHostName=`${fakeHostName}.workers.dev`,k=await 整理优选列表(addressesnotlsapi),P=await 整理测速结果("FALSE")):t.includes(".pages.dev")?fakeHostName=`${fakeHostName}.pages.dev`:t.includes("worker")||t.includes("notls")||"true"==noTLS?(noTLS="true",fakeHostName=`notls${fakeHostName}.net`,k=await 整理优选列表(addressesnotlsapi),P=await 整理测速结果("FALSE")):fakeHostName=`${fakeHostName}.xyz`,console.log(`虚假HOST: ${fakeHostName}`);let U=`${subProtocol}://${s}/sub?host=${fakeHostName}&uuid=${fakeUserID+atob("JmVkZ2V0dW5uZWw9Y21saXUmcHJveHlpcD0=")+n}&path=${encodeURIComponent(path)}`,T=!0;if(!s||""==s){if(t.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const D=await fetch(proxyhostsURL);if(!D.ok)return void console.error("获取地址时出错:",D.status,D.statusText);const C=await D.text(),A=C.split("\n").filter((e=>""!==e.trim()));proxyhosts=proxyhosts.concat(A)}catch(R){console.error("获取地址时出错:",R)}proxyhosts=[...new Set(proxyhosts)]}M=await 整理优选列表(addressesapi),x=await 整理测速结果("TRUE"),U=`https://${t}/${fakeUserID+r.search}`,(t.includes("worker")||t.includes("notls")||"true"==noTLS)&&(r.search?U+="&notls":U+="?notls"),console.log(`虚假订阅: ${U}`)}c.includes("CF-Workers-SUB".toLowerCase())||(c.includes("clash")&&!c.includes("nekobox")||r.searchParams.has("clash")&&!c.includes("subconverter")?(U=`${subProtocol}://${subConverter}/sub?target=clash&url=${encodeURIComponent(U)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,T=!1):(c.includes("sing-box")||c.includes("singbox")||(r.searchParams.has("singbox")||r.searchParams.has("sb"))&&!c.includes("subconverter"))&&(U=`${subProtocol}://${subConverter}/sub?target=singbox&url=${encodeURIComponent(U)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,T=!1));try{let L;if(s&&""!=s||1!=T){const j=await fetch(U,{headers:{"User-Agent":o+atob("IENGLVdvcmtlcnMtZWRnZXR1bm5lbC9jbWxpdQ==")}});L=await j.text()}else L=await 生成本地订阅(fakeHostName,fakeUserID,noTLS,M,x,k,P);return r.pathname==`/${fakeUserID}`?L:恢复伪装信息(L,e,t,T)}catch(E){return console.error("Error fetching content:",E),`Error fetching content: ${E.message}`}}}async function 整理优选列表(e){if(!e||0===e.length)return[];let t="";const s=new AbortController,o=setTimeout((()=>{s.abort()}),2e3);try{const o=await Promise.allSettled(e.map((e=>fetch(e,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lZGdldHVubmVsL2NtbGl1")},signal:s.signal}).then((e=>e.ok?e.text():Promise.reject())))));for(const[s,n]of o.entries())if("fulfilled"===n.status){const o=await n.value,r=o.split(/\r?\n/);let a="",l="443";if(r[0].split(",").length>3){const o=e[s].match(/id=([^&]*)/);o&&(a=o[1]);const n=e[s].match(/port=([^&]*)/);n&&(l=n[1]);for(let o=1;o<r.length;o++){const n=r[o].split(",")[0];n&&(t+=`${n}:${l}${a?`#${a}`:""}\n`,e[s].includes("proxyip=true")&&proxyIPPool.push(`${n}:${l}`))}}else e[s].includes("proxyip=true")&&(proxyIPPool=proxyIPPool.concat((await 整理(o)).map((e=>{const t=e.split("#")[0]||e;if(!t.includes(":"))return`${t}:443`;{const e=t.split(":")[1];if(!httpsPorts.includes(e))return t}return null})).filter(Boolean))),t+=o+"\n"}}catch(e){console.error(e)}finally{clearTimeout(o)}return await 整理(t)}async function 整理测速结果(e){if(!addressescsv||0===addressescsv.length)return[];let t=[];for(const s of addressescsv)try{const o=await fetch(s);if(!o.ok){console.error("获取CSV地址时出错:",o.status,o.statusText);continue}const n=await o.text();let r;r=n.includes("\r\n")?n.split("\r\n"):n.split("\n");const a=r[0].split(",").indexOf("TLS"),l=0,c=1,i=a+remarkIndex;if(-1===a){console.error("CSV文件缺少必需的字段");continue}for(let o=1;o<r.length;o++){const n=r[o].split(","),d=n.length-1;if(n[a].toUpperCase()===e&&parseFloat(n[d])>DLS){const e=n[l],o=n[c],r=`${e}:${o}#${n[i]}`;t.push(r),s.includes("proxyip=true")&&"true"==n[a].toUpperCase()&&!httpsPorts.includes(o)&&proxyIPPool.push(`${e}:${o}`)}}}catch(e){console.error("获取CSV地址时出错:",e);continue}return t}function 生成本地订阅(e,t,s,o,n,r,a){const l=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;let c;if(addresses=addresses.concat(o),addresses=addresses.concat(n),"true"==s){addressesnotls=addressesnotls.concat(r),addressesnotls=addressesnotls.concat(a);c=[...new Set(addressesnotls)].map((s=>{let o="-1",n=s;const r=n.match(l);if(r)s=r[1],o=r[2]||o,n=r[3]||s;else{if(s.includes(":")&&s.includes("#")){const e=s.split(":");s=e[0];const t=e[1].split("#");o=t[0],n=t[1]}else if(s.includes(":")){const e=s.split(":");s=e[0],o=e[1]}else if(s.includes("#")){const e=s.split("#");s=e[0],n=e[1]}n.includes(":")&&(n=n.split(":")[0])}const a=["8080","8880","2052","2082","2086","2095"];if(!isValidIPv4(s)&&"-1"==o)for(let e of a)if(s.includes(e)){o=e;break}"-1"==o&&(o="80");let c=e,i=path;return`${atob(啥啥啥_写的这是啥啊)}://${t}@${s}:${o+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT0mdHlwZT13cyZob3N0PQ==")+c}&path=${encodeURIComponent(i)}#${encodeURIComponent(n+"")}`})).join("\n")}const i=[...new Set(addresses)].map((s=>{let o="-1",n=s;const r=n.match(l);if(r)s=r[1],o=r[2]||o,n=r[3]||s;else{if(s.includes(":")&&s.includes("#")){const e=s.split(":");s=e[0];const t=e[1].split("#");o=t[0],n=t[1]}else if(s.includes(":")){const e=s.split(":");s=e[0],o=e[1]}else if(s.includes("#")){const e=s.split("#");s=e[0],n=e[1]}n.includes(":")&&(n=n.split(":")[0])}if(!isValidIPv4(s)&&"-1"==o)for(let e of httpsPorts)if(s.includes(e)){o=e;break}"-1"==o&&(o="443");let a=e,c=path,i="";const d=proxyIPPool.find((e=>e.includes(s)));d&&(c+=`&proxyip=${d}`),proxyhosts.length>0&&a.includes(".workers.dev")&&(c=`/${a}${c}`,a=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],i=" 已启用临时域名中转服务，请尽快绑定自定义域！");return`${atob(啥啥啥_写的这是啥啊)}://${t}@${s}:${o+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT10bHMmc25pPQ==")+a}&fp=random&type=ws&host=${a}&path=${encodeURIComponent(c)}#${encodeURIComponent(n+i)}`})).join("\n");let d=i;return"true"==s&&(d+=`\n${c}`),btoa(d)}async function 整理(e){var t=e.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");","==t.charAt(0)&&(t=t.slice(1)),","==t.charAt(t.length-1)&&(t=t.slice(0,t.length-1));return t.split(",")}async function sendMessage(e,t,s=""){if(BotToken&&ChatID)try{let o="";const n=await fetch(`http://ip-api.com/json/${t}?lang=zh-CN`);if(n.ok){const r=await n.json();o=`${e}\nIP: ${t}\n国家: ${r.country}\n<tg-spoiler>城市: ${r.city}\n组织: ${r.org}\nASN: ${r.as}\n${s}`}else o=`${e}\nIP: ${t}\n<tg-spoiler>${s}`;const r=`https://api.telegram.org/bot${BotToken}/sendMessage?chat_id=${ChatID}&parse_mode=HTML&text=${encodeURIComponent(o)}`;return fetch(r,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}catch(e){console.error("Error sending message:",e)}}function isValidIPv4(e){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}function 生成动态UUID(e){const t=new Date(2007,6,7,更新时间,0,0),s=864e5*有效时间;function 生成UUID(e){const t=(new TextEncoder).encode(e);return crypto.subtle.digest("SHA-256",t).then((e=>{const t=Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("");return`${t.substr(0,8)}-${t.substr(8,4)}-4${t.substr(13,3)}-${(63&parseInt(t.substr(16,2),16)|128).toString(16)}${t.substr(18,2)}-${t.substr(20,12)}`}))}const o=function(){const e=new Date,o=new Date(e.getTime()+288e5)-t;return Math.ceil(o/s)}(),n=new Date(t.getTime()+o*s),r=生成UUID(e+o),a=生成UUID(e+(o-1)),l=`到期时间(UTC): ${new Date(n.getTime()-288e5).toISOString().slice(0,19).replace("T"," ")} (UTC+8): ${n.toISOString().slice(0,19).replace("T"," ")}\n`;return Promise.all([r,a,l])}
