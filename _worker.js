import{connect}from"cloudflare:sockets";let fakeUserID,fakeHostName,userID="",proxyIP="",sub="",subConverter="SUBAPI.fxxk.dedyn.io",subConfig="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online_Mini_MultiMode.ini",subProtocol="https",subEmoji="true",socks5Address="",parsedSocks5Address={},enableSocks=!1,noTLS="false";const expire=4102329600;let proxyIPs,socks5s,BotToken,ChatID,userIDLow,动态UUID,go2Socks5s=["*ttvnw.net","*tapecontent.net","*cloudatacdn.com","*.loadshare.org"],addresses=[],addressesapi=[],addressesnotls=[],addressesnotlsapi=[],addressescsv=[],DLS=8,remarkIndex=1,FileName=atob("ZWRnZXR1bm5lbA=="),proxyhosts=[],proxyhostsURL="",RproxyIP="false",httpsPorts=["2053","2083","2087","2096","8443"],有效时间=7,更新时间=3,userIDTime="",proxyIPPool=[],path="/?ed=2560",link=[],banHosts=[atob("c3BlZWQuY2xvdWRmbGFyZS5jb20=")];export default{async fetch(t,e,s){try{const s=t.headers.get("User-Agent")||"null",n=s.toLowerCase();if(userID=e.UUID||e.uuid||e.PASSWORD||e.pswd||userID,e.KEY||e.TOKEN||userID&&!isValidUUID(userID)){动态UUID=e.KEY||e.TOKEN||userID,有效时间=Number(e.TIME)||有效时间,更新时间=Number(e.UPTIME)||更新时间;const t=await 生成动态UUID(动态UUID);userID=t[0],userIDLow=t[1]}if(!userID)return new Response("请设置你的UUID变量，或尝试重试部署，检查变量是否生效？",{status:404,headers:{"Content-Type":"text/plain;charset=utf-8"}});const r=new Date;r.setHours(0,0,0,0);const o=Math.ceil(r.getTime()/1e3),a=await 双重哈希(`${userID}${o}`);if(fakeUserID=[a.slice(0,8),a.slice(8,12),a.slice(12,16),a.slice(16,20),a.slice(20)].join("-"),fakeHostName=`${a.slice(6,9)}.${a.slice(13,19)}`,proxyIP=e.PROXYIP||e.proxyip||proxyIP,proxyIPs=await 整理(proxyIP),proxyIP=proxyIPs[Math.floor(Math.random()*proxyIPs.length)],socks5Address=e.SOCKS5||socks5Address,socks5s=await 整理(socks5Address),socks5Address=socks5s[Math.floor(Math.random()*socks5s.length)],socks5Address=socks5Address.split("//")[1]||socks5Address,e.GO2SOCKS5&&(go2Socks5s=await 整理(e.GO2SOCKS5)),e.CFPORTS&&(httpsPorts=await 整理(e.CFPORTS)),e.BAN&&(banHosts=await 整理(e.BAN)),socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),RproxyIP=e.RPROXYIP||"false",enableSocks=!0}catch(t){let s=t;console.log(s.toString()),RproxyIP=e.RPROXYIP||!proxyIP?"true":"false",enableSocks=!1}else RproxyIP=e.RPROXYIP||!proxyIP?"true":"false";const l=t.headers.get("Upgrade"),i=new URL(t.url);if(l&&"websocket"===l){if(socks5Address=i.searchParams.get("socks5")||socks5Address,new RegExp("/socks5=","i").test(i.pathname))socks5Address=i.pathname.split("5=")[1];else if((new RegExp("/socks://","i").test(i.pathname)||new RegExp("/socks5://","i").test(i.pathname))&&(socks5Address=i.pathname.split("://")[1].split("#")[0],socks5Address.includes("@"))){let t=socks5Address.split("@")[0];/^(?:[A-Z0-9+/]{4})*(?:[A-Z0-9+/]{2}==|[A-Z0-9+/]{3}=)?$/i.test(t)&&!t.includes(":")&&(t=atob(t)),socks5Address=`${t}@${socks5Address.split("@")[1]}`}if(socks5Address)try{parsedSocks5Address=socks5AddressParser(socks5Address),enableSocks=!0}catch(t){let e=t;console.log(e.toString()),enableSocks=!1}else enableSocks=!1;return i.searchParams.has("proxyip")?(proxyIP=i.searchParams.get("proxyip"),enableSocks=!1):new RegExp("/proxyip=","i").test(i.pathname)?(proxyIP=i.pathname.toLowerCase().split("/proxyip=")[1],enableSocks=!1):new RegExp("/proxyip.","i").test(i.pathname)&&(proxyIP=`proxyip.${i.pathname.toLowerCase().split("/proxyip.")[1]}`,enableSocks=!1),await 维列斯OverWSHandler(t)}{e.ADD&&(addresses=await 整理(e.ADD)),e.ADDAPI&&(addressesapi=await 整理(e.ADDAPI)),e.ADDNOTLS&&(addressesnotls=await 整理(e.ADDNOTLS)),e.ADDNOTLSAPI&&(addressesnotlsapi=await 整理(e.ADDNOTLSAPI)),e.ADDCSV&&(addressescsv=await 整理(e.ADDCSV)),DLS=Number(e.DLS)||DLS,remarkIndex=Number(e.CSVREMARK)||remarkIndex,BotToken=e.TGTOKEN||BotToken,ChatID=e.TGID||ChatID,FileName=e.SUBNAME||FileName,subEmoji=e.SUBEMOJI||e.EMOJI||subEmoji,"0"==subEmoji&&(subEmoji="false"),e.LINK&&(link=await 整理(e.LINK)),sub=e.SUB||sub,subConverter=e.SUBAPI||subConverter,subConverter.includes("http://")?(subConverter=subConverter.split("//")[1],subProtocol="http"):subConverter=subConverter.split("//")[1]||subConverter,subConfig=e.SUBCONFIG||subConfig,i.searchParams.has("sub")&&""!==i.searchParams.get("sub")&&(sub=i.searchParams.get("sub")),i.searchParams.has("notls")&&(noTLS="true"),i.searchParams.has("proxyip")?(path=`/?ed=2560&proxyip=${i.searchParams.get("proxyip")}`,RproxyIP="false"):i.searchParams.has("socks5")?(path=`/?ed=2560&socks5=${i.searchParams.get("socks5")}`,RproxyIP="false"):i.searchParams.has("socks")&&(path=`/?ed=2560&socks5=${i.searchParams.get("socks")}`,RproxyIP="false");const r=i.pathname.toLowerCase();if("/"==r)return e.URL302?Response.redirect(e.URL302,302):e.URL?await 代理URL(e.URL,i):new Response(JSON.stringify(t.cf,null,4),{status:200,headers:{"content-type":"application/json"}});if(r==`/${fakeUserID}`){const s=await 生成配置信息(userID,t.headers.get("Host"),sub,"CF-Workers-SUB",RproxyIP,i,e);return new Response(`${s}`,{status:200})}if(i.pathname==`/${动态UUID}/edit`||r==`/${userID}/edit`){return await KV(t,e)}if(i.pathname==`/${动态UUID}`||r==`/${userID}`){await sendMessage(`#获取订阅 ${FileName}`,t.headers.get("CF-Connecting-IP"),`UA: ${s}</tg-spoiler>\n域名: ${i.hostname}\n<tg-spoiler>入口: ${i.pathname+i.search}</tg-spoiler>`);const r=await 生成配置信息(userID,t.headers.get("Host"),sub,s,RproxyIP,i,e),o=Date.now(),a=new Date(o);a.setHours(0,0,0,0);const l=Math.floor((o-a.getTime())/864e5*24*1099511627776/2);let c=l,d=l,p=26388279066624;return n&&n.includes("mozilla")?new Response(`<div style="font-size:13px;">${r}</div>`,{status:200,headers:{"Content-Type":"text/html;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${c}; download=${d}; total=${p}; expire=${expire}`,"Cache-Control":"no-store"}}):new Response(`${r}`,{status:200,headers:{"Content-Disposition":`attachment; filename=${FileName}; filename*=utf-8''${encodeURIComponent(FileName)}`,"Content-Type":"text/plain;charset=utf-8","Profile-Update-Interval":"6","Subscription-Userinfo":`upload=${c}; download=${d}; total=${p}; expire=${expire}`}})}return e.URL302?Response.redirect(e.URL302,302):e.URL?await 代理URL(e.URL,i):new Response("不用怀疑！你UUID就是错的！！！",{status:404})}}catch(t){return new Response(t.toString())}}};async function 维列斯OverWSHandler(t){const e=new WebSocketPair,[s,n]=Object.values(e);n.accept();let r="",o="";const log=(t,e)=>{console.log(`[${r}:${o}] ${t}`,e||"")},a=t.headers.get("sec-websocket-protocol")||"",l=makeReadableWebSocketStream(n,a,log);let i={value:null},c=!1;return l.pipeTo(new WritableStream({async write(t,e){if(c)return await handleDNSQuery(t,n,null,log);if(i.value){const e=i.value.writable.getWriter();return await e.write(t),void e.releaseLock()}const{hasError:s,message:a,addressType:l,portRemote:d=443,addressRemote:p="",rawDataIndex:u,"维列斯Version":b=new Uint8Array([0,0]),isUDP:h}=process维列斯Header(t,userID);if(r=p,o=`${d}--${Math.random()} ${h?"udp ":"tcp "} `,s)throw new Error(a);if(h){if(53!==d)throw new Error("UDP 代理仅对 DNS（53 端口）启用");c=!0}const y=new Uint8Array([b[0],0]),m=t.slice(u);if(c)return handleDNSQuery(m,n,y,log);if(banHosts.includes(p))throw new Error(`黑名单关闭 TCP 出站连接 ${p}:${d}`);log(`处理 TCP 出站连接 ${p}:${d}`),handleTCPOutBound(i,l,p,d,m,n,y,log)},close(){log("readableWebSocketStream 已关闭")},abort(t){log("readableWebSocketStream 已中止",JSON.stringify(t))}})).catch((t=>{log("readableWebSocketStream 管道错误",t)})),new Response(null,{status:101,webSocket:s})}async function handleTCPOutBound(t,e,s,n,r,o,a,l){async function connectAndWrite(s,n,o=!1){l(`connected to ${s}:${n}`);const a=o?await socks5Connect(e,s,n,l):connect({hostname:s,port:n});t.value=a;const i=a.writable.getWriter();return await i.write(r),i.releaseLock(),a}let i=!1;go2Socks5s.length>0&&enableSocks&&(i=await async function(t){return!(!go2Socks5s.includes(atob("YWxsIGlu"))&&!go2Socks5s.includes(atob("Kg==")))||go2Socks5s.some((e=>{let s=e.replace(/\*/g,".*");return new RegExp(`^${s}$`,"i").test(t)}))}(s));let c=await connectAndWrite(s,n,i);remoteSocketToWS(c,o,a,(async function(){enableSocks?c=await connectAndWrite(s,n,!0):(proxyIP&&""!=proxyIP?proxyIP.includes("]:")?(n=proxyIP.split("]:")[1]||n,proxyIP=proxyIP.split("]:")[0]||proxyIP):2===proxyIP.split(":").length&&(n=proxyIP.split(":")[1]||n,proxyIP=proxyIP.split(":")[0]||proxyIP):proxyIP=atob("UFJPWFlJUC50cDEuZnh4ay5kZWR5bi5pbw=="),proxyIP.includes(".tp")&&(n=proxyIP.split(".tp")[1].split(".")[0]||n),c=await connectAndWrite(proxyIP||s,n)),c.closed.catch((t=>{console.log("retry tcpSocket closed error",t)})).finally((()=>{safeCloseWebSocket(o)})),remoteSocketToWS(c,o,a,null,l)}),l)}function makeReadableWebSocketStream(t,e,s){let n=!1;return new ReadableStream({start(r){t.addEventListener("message",(t=>{if(n)return;const e=t.data;r.enqueue(e)})),t.addEventListener("close",(()=>{safeCloseWebSocket(t),n||r.close()})),t.addEventListener("error",(t=>{s("WebSocket 服务器发生错误"),r.error(t)}));const{earlyData:o,error:a}=base64ToArrayBuffer(e);a?r.error(a):o&&r.enqueue(o)},pull(t){},cancel(e){n||(s(`可读流被取消，原因是 ${e}`),n=!0,safeCloseWebSocket(t))}})}function process维列斯Header(t,e){if(t.byteLength<24)return{hasError:!0,message:"invalid data"};const s=new Uint8Array(t.slice(0,1));let n=!1,r=!1;if(n=function(t,e,s){const n=stringify(new Uint8Array(s.slice(1,17)));return n===t||n===e}(e,userIDLow,t),!n)return{hasError:!0,message:`invalid user ${new Uint8Array(t.slice(1,17))}`};const o=new Uint8Array(t.slice(17,18))[0],a=new Uint8Array(t.slice(18+o,18+o+1))[0];if(1===a);else{if(2!==a)return{hasError:!0,message:`command ${a} is not support, command 01-tcp,02-udp,03-mux`};r=!0}const l=18+o+1,i=t.slice(l,l+2),c=new DataView(i).getUint16(0);let d=l+2;const p=new Uint8Array(t.slice(d,d+1))[0];let u=0,b=d+1,h="";switch(p){case 1:u=4,h=new Uint8Array(t.slice(b,b+u)).join(".");break;case 2:u=new Uint8Array(t.slice(b,b+1))[0],b+=1,h=(new TextDecoder).decode(t.slice(b,b+u));break;case 3:u=16;const e=new DataView(t.slice(b,b+u)),s=[];for(let t=0;t<8;t++)s.push(e.getUint16(2*t).toString(16));h=s.join(":");break;default:return{hasError:!0,message:`invild addressType is ${p}`}}return h?{hasError:!1,addressRemote:h,addressType:p,portRemote:c,rawDataIndex:b+u,"维列斯Version":s,isUDP:r}:{hasError:!0,message:`addressValue is empty, addressType is ${p}`}}async function remoteSocketToWS(t,e,s,n,r){let o=s,a=!1;await t.readable.pipeTo(new WritableStream({start(){},async write(t,s){a=!0,e.readyState!==WS_READY_STATE_OPEN&&s.error("webSocket.readyState is not open, maybe close"),o?(e.send(await new Blob([o,t]).arrayBuffer()),o=null):e.send(t)},close(){r(`remoteConnection!.readable is close with hasIncomingData is ${a}`)},abort(t){console.error("remoteConnection!.readable abort",t)}})).catch((t=>{console.error("remoteSocketToWS has exception ",t.stack||t),safeCloseWebSocket(e)})),!1===a&&n&&(r("retry"),n())}function base64ToArrayBuffer(t){if(!t)return{earlyData:void 0,error:null};try{t=t.replace(/-/g,"+").replace(/_/g,"/");const e=atob(t);return{earlyData:Uint8Array.from(e,(t=>t.charCodeAt(0))).buffer,error:null}}catch(t){return{earlyData:void 0,error:t}}}function isValidUUID(t){return/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t)}const WS_READY_STATE_OPEN=1,WS_READY_STATE_CLOSING=2;function safeCloseWebSocket(t){try{t.readyState!==WS_READY_STATE_OPEN&&t.readyState!==WS_READY_STATE_CLOSING||t.close()}catch(t){console.error("safeCloseWebSocket error",t)}}const byteToHex=[];for(let t=0;t<256;++t)byteToHex.push((t+256).toString(16).slice(1));function unsafeStringify(t,e=0){return(byteToHex[t[e+0]]+byteToHex[t[e+1]]+byteToHex[t[e+2]]+byteToHex[t[e+3]]+"-"+byteToHex[t[e+4]]+byteToHex[t[e+5]]+"-"+byteToHex[t[e+6]]+byteToHex[t[e+7]]+"-"+byteToHex[t[e+8]]+byteToHex[t[e+9]]+"-"+byteToHex[t[e+10]]+byteToHex[t[e+11]]+byteToHex[t[e+12]]+byteToHex[t[e+13]]+byteToHex[t[e+14]]+byteToHex[t[e+15]]).toLowerCase()}function stringify(t,e=0){const s=unsafeStringify(t,e);if(!isValidUUID(s))throw TypeError(`生成的 UUID 不符合规范 ${s}`);return s}async function handleDNSQuery(t,e,s,n){try{const r="8.8.4.4",o=53;let a=s;const l=connect({hostname:r,port:o});n(`连接到 ${r}:${o}`);const i=l.writable.getWriter();await i.write(t),i.releaseLock(),await l.readable.pipeTo(new WritableStream({async write(t){e.readyState===WS_READY_STATE_OPEN&&(a?(e.send(await new Blob([a,t]).arrayBuffer()),a=null):e.send(t))},close(){n(`DNS 服务器(${r}) TCP 连接已关闭`)},abort(t){console.error(`DNS 服务器(${r}) TCP 连接异常中断`,t)}}))}catch(t){console.error(`handleDNSQuery 函数发生异常，错误信息: ${t.message}`)}}async function socks5Connect(t,e,s,n){const{username:r,password:o,hostname:a,port:l}=parsedSocks5Address,i=connect({hostname:a,port:l}),c=new Uint8Array([5,2,0,2]),d=i.writable.getWriter();await d.write(c),n("已发送 SOCKS5 问候消息");const p=i.readable.getReader(),u=new TextEncoder;let b,h=(await p.read()).value;if(5!==h[0])return void n(`SOCKS5 服务器版本错误: 收到 ${h[0]}，期望是 5`);if(255===h[1])return void n("服务器不接受任何认证方法");if(2===h[1]){if(n("SOCKS5 服务器需要认证"),!r||!o)return void n("请提供用户名和密码");const t=new Uint8Array([1,r.length,...u.encode(r),o.length,...u.encode(o)]);if(await d.write(t),h=(await p.read()).value,1!==h[0]||0!==h[1])return void n("SOCKS5 服务器认证失败")}switch(t){case 1:b=new Uint8Array([1,...e.split(".").map(Number)]);break;case 2:b=new Uint8Array([3,e.length,...u.encode(e)]);break;case 3:b=new Uint8Array([4,...e.split(":").flatMap((t=>[parseInt(t.slice(0,2),16),parseInt(t.slice(2),16)]))]);break;default:return void n(`无效的地址类型: ${t}`)}const y=new Uint8Array([5,1,0,...b,s>>8,255&s]);if(await d.write(y),n("已发送 SOCKS5 请求"),h=(await p.read()).value,0===h[1])return n("SOCKS5 连接已建立"),d.releaseLock(),p.releaseLock(),i;n("SOCKS5 连接建立失败")}function socks5AddressParser(t){let e,s,n,r,[o,a]=t.split("@").reverse();if(a){const t=a.split(":");if(2!==t.length)throw new Error('无效的 SOCKS 地址格式：认证部分必须是 "username:password" 的形式');[e,s]=t}const l=o.split(":");if(r=Number(l.pop()),isNaN(r))throw new Error("无效的 SOCKS 地址格式：端口号必须是数字");n=l.join(":");if(n.includes(":")&&!/^\[.*\]$/.test(n))throw new Error("无效的 SOCKS 地址格式：IPv6 地址必须用方括号括起来，如 [2001:db8::1]");return{username:e,password:s,hostname:n,port:r}}function 恢复伪装信息(t,e,s,n){return n&&(t=atob(t)),t=t.replace(new RegExp(fakeUserID,"g"),e).replace(new RegExp(fakeHostName,"g"),s),n&&(t=btoa(t)),t}async function 双重哈希(t){const e=new TextEncoder,s=await crypto.subtle.digest("MD5",e.encode(t)),n=Array.from(new Uint8Array(s)).map((t=>t.toString(16).padStart(2,"0"))).join(""),r=await crypto.subtle.digest("MD5",e.encode(n.slice(7,27)));return Array.from(new Uint8Array(r)).map((t=>t.toString(16).padStart(2,"0"))).join("").toLowerCase()}async function 代理URL(t,e){const s=await 整理(t),n=s[Math.floor(Math.random()*s.length)];let r=new URL(n);console.log(r);let o=r.protocol.slice(0,-1)||"https",a=r.hostname,l=r.pathname,i=r.search;"/"==l.charAt(l.length-1)&&(l=l.slice(0,-1)),l+=e.pathname;let c=`${o}://${a}${l}${i}`,d=await fetch(c),p=new Response(d.body,{status:d.status,statusText:d.statusText,headers:d.headers});return p.headers.set("X-New-URL",c),p}const 啥啥啥_写的这是啥啊=atob("ZG14bGMzTT0=");function 配置信息(t,e){const s=atob(啥啥啥_写的这是啥啊),n=FileName;let r=e,o=443;const a=t,l=e,i=path;let c=["tls",!0];const d=e,p="randomized";e.includes(".workers.dev")&&(r=atob("dmlzYS5jbg=="),o=80,c=["",!1]);return[`${s}://${a}@${r}:${o}?encryp${atob("dGlvbj0=")+"none"}&security=${c[0]}&sni=${d}&fp=${p}&type=ws&host=${l}&path=${encodeURIComponent(i)}#${encodeURIComponent(n)}`,`- {name: ${FileName}, server: ${r}, port: ${o}, type: ${s}, uuid: ${a}, tls: ${c[1]}, alpn: [h3], udp: false, sni: ${d}, tfo: false, skip-cert-verify: true, servername: ${l}, client-fingerprint: ${p}, network: ws, ws-opts: {path: "${i}", headers: {${l}}}}`]}let subParams=["sub","base64","b64","clash","singbox","sb"];const cmad=decodeURIComponent(atob("dGVsZWdyYW0lMjAlRTQlQkElQTQlRTYlQjUlODElRTclQkUlQTQlMjAlRTYlOEElODAlRTYlOUMlQUYlRTUlQTQlQTclRTQlQkQlQUMlN0UlRTUlOUMlQTglRTclQkElQkYlRTUlOEYlOTElRTclODklOEMhJTNDYnIlM0UKJTNDYSUyMGhyZWYlM0QlMjdodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlMjclM0VodHRwcyUzQSUyRiUyRnQubWUlMkZDTUxpdXNzc3MlM0MlMkZhJTNFJTNDYnIlM0UKLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJTNDYnIlM0UKZ2l0aHViJTIwJUU5JUExJUI5JUU3JTlCJUFFJUU1JTlDJUIwJUU1JTlEJTgwJTIwU3RhciFTdGFyIVN0YXIhISElM0NiciUzRQolM0NhJTIwaHJlZiUzRCUyN2h0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZWRnZXR1bm5lbCUyNyUzRWh0dHBzJTNBJTJGJTJGZ2l0aHViLmNvbSUyRmNtbGl1JTJGZWRnZXR1bm5lbCUzQyUyRmElM0UlM0NiciUzRQotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0lM0NiciUzRQolMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjMlMjM="));async function 生成配置信息(t,e,s,n,r,o,a){if(s){const b=s.match(/^(?:https?:\/\/)?([^\/]+)/);b&&(s=b[1]);const h=await 整理(s);h.length>1&&(s=h[0])}else{if(a.KV){const y=await a.KV.get("/ADD.txt");if(y){const m=await 整理(y),U={"接口地址":new Set,"链接地址":new Set,"优选地址":new Set};for(const f of m)f.startsWith("https://")?U.接口地址.add(f):f.includes("://")?U.链接地址.add(f):U.优选地址.add(f);addressesapi=[...U.接口地址],link=[...U.链接地址],addresses=[...U.优选地址]}}if(addresses.length+addressesapi.length+addressesnotls.length+addressesnotlsapi.length+addressescsv.length==0){let S=["103.21.244.0/23","104.16.0.0/13","104.24.0.0/14","172.64.0.0/14","103.21.244.0/23","104.16.0.0/14","104.24.0.0/15","141.101.64.0/19","172.64.0.0/14","188.114.96.0/21","190.93.240.0/21"];function generateRandomIPFromCIDR(t){const[e,s]=t.split("/"),n=e.split(".").map(Number),r=32-parseInt(s,10),o=Math.pow(2,r)-1,a=Math.floor(Math.random()*o);return n.map(((t,e)=>e<2?t:2===e?(t&255<<r-8)+(a>>8&255):(t&255<<r)+(255&a))).join(".")}addresses=addresses.concat("127.0.0.1:1234#CFnat"),e.includes(".workers.dev")?addressesnotls=addressesnotls.concat(S.map((t=>generateRandomIPFromCIDR(t)+"#CF随机节点"))):addresses=addresses.concat(S.map((t=>generateRandomIPFromCIDR(t)+"#CF随机节点")))}}const l=o.pathname==`/${动态UUID}`?动态UUID:t,i=n.toLowerCase(),c=配置信息(t,e),d=c[0],p=c[1];let u="";if(e.includes(".workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const w=await fetch(proxyhostsURL);if(!w.ok)return void console.error("获取地址时出错:",w.status,w.statusText);const $=await w.text(),T=$.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(T)}catch(M){}0!=proxyhosts.length&&(u=proxyhosts[Math.floor(Math.random()*proxyhosts.length)]+"/")}if(i.includes("mozilla")&&!subParams.some((t=>o.searchParams.has(t)))){const g=socks5s.map((t=>t.includes("@")?t.split("@")[1]:t.includes("//")?t.split("//")[1]:t));let x="";go2Socks5s.length>0&&enableSocks&&(x=`${decodeURIComponent("SOCKS5%EF%BC%88%E7%99%BD%E5%90%8D%E5%8D%95%EF%BC%89%3A%20")}`,go2Socks5s.includes(atob("YWxsIGlu"))||go2Socks5s.includes(atob("Kg=="))?x+=`${decodeURIComponent("%E6%89%80%E6%9C%89%E6%B5%81%E9%87%8F")}<br>`:x+=`<br>&nbsp;&nbsp;${go2Socks5s.join("<br>&nbsp;&nbsp;")}<br>`);let I="<br>";if(s)I+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${g.join("<br>&nbsp;&nbsp;")}<br>${x}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"true"==r?"CFCDN（访问方式）: 自动获取ProxyIP<br>":"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>",I+=`<br>SUB（优选订阅生成器）: ${s}`;else{I+=enableSocks?`CFCDN（访问方式）: Socks5<br>&nbsp;&nbsp;${g.join("<br>&nbsp;&nbsp;")}<br>${x}`:proxyIP&&""!=proxyIP?`CFCDN（访问方式）: ProxyIP<br>&nbsp;&nbsp;${proxyIPs.join("<br>&nbsp;&nbsp;")}<br>`:"CFCDN（访问方式）: 无法访问, 需要您设置 proxyIP/PROXYIP ！！！<br>";let C="";a.KV&&(C=` <a href='${o.pathname}/edit'>编辑优选列表</a>`),I+=`<br>您的订阅内容由 内置 addresses/ADD* 参数变量提供${C}<br>`,addresses.length>0&&(I+=`ADD（TLS优选域名&IP）: <br>&nbsp;&nbsp;${addresses.join("<br>&nbsp;&nbsp;")}<br>`),addressesnotls.length>0&&(I+=`ADDNOTLS（noTLS优选域名&IP）: <br>&nbsp;&nbsp;${addressesnotls.join("<br>&nbsp;&nbsp;")}<br>`),addressesapi.length>0&&(I+=`ADDAPI（TLS优选域名&IP 的 API）: <br>&nbsp;&nbsp;${addressesapi.join("<br>&nbsp;&nbsp;")}<br>`),addressesnotlsapi.length>0&&(I+=`ADDNOTLSAPI（noTLS优选域名&IP 的 API）: <br>&nbsp;&nbsp;${addressesnotlsapi.join("<br>&nbsp;&nbsp;")}<br>`),addressescsv.length>0&&(I+=`ADDCSV（IPTest测速csv文件 限速 ${DLS} ）: <br>&nbsp;&nbsp;${addressescsv.join("<br>&nbsp;&nbsp;")}<br>`)}动态UUID&&o.pathname!==`/${动态UUID}`?I="":I+=`<br>SUBAPI（订阅转换后端）: ${subProtocol}://${subConverter}<br>SUBCONFIG（订阅转换配置文件）: ${subConfig}`;return`\n\t\t\t################################################################<br>\n\t\t\tSubscribe / sub 订阅地址, 支持 Base64、clash-meta、sing-box 订阅格式<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t自适应订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}</a><br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?sub')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?sub</a><br>\n\t\t\t<br>\n\t\t\tBase64订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?b64')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?b64</a><br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?base64')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?base64</a><br>\n\t\t\t<br>\n\t\t\tclash订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?clash')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?clash</a><br>\n\t\t\t<br>\n\t\t\tsingbox订阅地址:<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?sb')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?sb</a><br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('https://${u}${e}/${l}?singbox')" style="color:blue;text-decoration:underline;cursor:pointer;">https://${u}${e}/${l}?singbox</a><br>\n\n\t\t\t<script>\n\t\t\tfunction copyToClipboard(text) {\n\t\t\t\tnavigator.clipboard.writeText(text).then(() => {\n\t\t\t\t\talert('已复制到剪贴板');\n\t\t\t\t}).catch(err => {\n\t\t\t\t\tconsole.error('复制失败:', err);\n\t\t\t\t});\n\t\t\t}\n\t\t\t<\/script>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${FileName} 配置信息<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t${l!=t?`TOKEN: ${l}<br>UUIDNow: ${t}<br>UUIDLow: ${userIDLow}<br>${userIDTime}TIME（动态UUID有效时间）: ${有效时间} 天<br>UPTIME（动态UUID更新时间）: ${更新时间} 时（北京时间）<br><br>`:`${userIDTime}`}HOST: ${e}<br>\n\t\t\tUUID: ${t}<br>\n\t\t\tFKID: ${fakeUserID}<br>\n\t\t\tUA: ${n}<br>\n\t\t\t${I}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tv2ray<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t<a href="javascript:void(0)" onclick="copyToClipboard('${d}')" style="color:blue;text-decoration:underline;cursor:pointer;">${d}</a><br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\tclash-meta<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t${p}<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t################################################################<br>\n\t\t\t${cmad}\n\t\t\t`}{if("function"!=typeof fetch)return"Error: fetch is not available in this environment.";let k=[],R=[],D=[],P=[];e.includes(".workers.dev")?(noTLS="true",fakeHostName=`${fakeHostName}.workers.dev`,D=await 整理优选列表(addressesnotlsapi),P=await 整理测速结果("FALSE")):e.includes(".pages.dev")?fakeHostName=`${fakeHostName}.pages.dev`:e.includes("worker")||e.includes("notls")||"true"==noTLS?(noTLS="true",fakeHostName=`notls${fakeHostName}.net`,D=await 整理优选列表(addressesnotlsapi),P=await 整理测速结果("FALSE")):fakeHostName=`${fakeHostName}.xyz`,console.log(`虚假HOST: ${fakeHostName}`);let N=`${subProtocol}://${s}/sub?host=${fakeHostName}&uuid=${fakeUserID+atob("JmVkZ2V0dW5uZWw9Y21saXUmcHJveHlpcD0=")+r}&path=${encodeURIComponent(path)}`,A=!0;if(!s||""==s){if(e.includes("workers.dev")){if(proxyhostsURL&&(!proxyhosts||0==proxyhosts.length))try{const j=await fetch(proxyhostsURL);if(!j.ok)return void console.error("获取地址时出错:",j.status,j.statusText);const v=await j.text(),E=v.split("\n").filter((t=>""!==t.trim()));proxyhosts=proxyhosts.concat(E)}catch(L){console.error("获取地址时出错:",L)}proxyhosts=[...new Set(proxyhosts)]}k=await 整理优选列表(addressesapi),R=await 整理测速结果("TRUE"),N=`https://${e}/${fakeUserID+o.search}`,(e.includes("worker")||e.includes("notls")||"true"==noTLS)&&(o.search?N+="&notls":N+="?notls"),console.log(`虚假订阅: ${N}`)}i.includes("CF-Workers-SUB".toLowerCase())||(i.includes("clash")&&!i.includes("nekobox")||o.searchParams.has("clash")&&!i.includes("subconverter")?(N=`${subProtocol}://${subConverter}/sub?target=clash&url=${encodeURIComponent(N)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,A=!1):(i.includes("sing-box")||i.includes("singbox")||(o.searchParams.has("singbox")||o.searchParams.has("sb"))&&!i.includes("subconverter"))&&(N=`${subProtocol}://${subConverter}/sub?target=singbox&url=${encodeURIComponent(N)}&insert=false&config=${encodeURIComponent(subConfig)}&emoji=${subEmoji}&list=false&tfo=false&scv=true&fdn=false&sort=false&new_name=true`,A=!1));try{let V;if(s&&""!=s||1!=A){const Q=await fetch(N,{headers:{"User-Agent":n+atob("IENGLVdvcmtlcnMtZWRnZXR1bm5lbC9jbWxpdQ==")}});V=await Q.text()}else V=await 生成本地订阅(fakeHostName,fakeUserID,noTLS,k,R,D,P);return o.pathname==`/${fakeUserID}`?V:恢复伪装信息(V,t,e,A)}catch(O){return console.error("Error fetching content:",O),`Error fetching content: ${O.message}`}}}async function 整理优选列表(t){if(!t||0===t.length)return[];let e="";const s=new AbortController,n=setTimeout((()=>{s.abort()}),2e3);try{const n=await Promise.allSettled(t.map((t=>fetch(t,{method:"get",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","User-Agent":atob("Q0YtV29ya2Vycy1lZGdldHVubmVsL2NtbGl1")},signal:s.signal}).then((t=>t.ok?t.text():Promise.reject())))));for(const[s,r]of n.entries())if("fulfilled"===r.status){const n=await r.value,o=n.split(/\r?\n/);let a="",l="443";if(o[0].split(",").length>3){const n=t[s].match(/id=([^&]*)/);n&&(a=n[1]);const r=t[s].match(/port=([^&]*)/);r&&(l=r[1]);for(let n=1;n<o.length;n++){const r=o[n].split(",")[0];r&&(e+=`${r}:${l}${a?`#${a}`:""}\n`,t[s].includes("proxyip=true")&&proxyIPPool.push(`${r}:${l}`))}}else t[s].includes("proxyip=true")&&(proxyIPPool=proxyIPPool.concat((await 整理(n)).map((t=>{const e=t.split("#")[0]||t;if(!e.includes(":"))return`${e}:443`;{const t=e.split(":")[1];if(!httpsPorts.includes(t))return e}return null})).filter(Boolean))),e+=n+"\n"}}catch(t){console.error(t)}finally{clearTimeout(n)}return await 整理(e)}async function 整理测速结果(t){if(!addressescsv||0===addressescsv.length)return[];let e=[];for(const s of addressescsv)try{const n=await fetch(s);if(!n.ok){console.error("获取CSV地址时出错:",n.status,n.statusText);continue}const r=await n.text();let o;o=r.includes("\r\n")?r.split("\r\n"):r.split("\n");const a=o[0].split(",").indexOf("TLS"),l=0,i=1,c=a+remarkIndex;if(-1===a){console.error("CSV文件缺少必需的字段");continue}for(let n=1;n<o.length;n++){const r=o[n].split(","),d=r.length-1;if(r[a].toUpperCase()===t&&parseFloat(r[d])>DLS){const t=r[l],n=r[i],o=`${t}:${n}#${r[c]}`;e.push(o),s.includes("proxyip=true")&&"true"==r[a].toUpperCase()&&!httpsPorts.includes(n)&&proxyIPPool.push(`${t}:${n}`)}}}catch(t){console.error("获取CSV地址时出错:",t);continue}return e}function 生成本地订阅(t,e,s,n,r,o,a){const l=/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}|\[.*\]):?(\d+)?#?(.*)?$/;let i;if(addresses=addresses.concat(n),addresses=addresses.concat(r),"true"==s){addressesnotls=addressesnotls.concat(o),addressesnotls=addressesnotls.concat(a);i=[...new Set(addressesnotls)].map((s=>{let n="-1",r=s;const o=r.match(l);if(o)s=o[1],n=o[2]||n,r=o[3]||s;else{if(s.includes(":")&&s.includes("#")){const t=s.split(":");s=t[0];const e=t[1].split("#");n=e[0],r=e[1]}else if(s.includes(":")){const t=s.split(":");s=t[0],n=t[1]}else if(s.includes("#")){const t=s.split("#");s=t[0],r=t[1]}r.includes(":")&&(r=r.split(":")[0])}const a=["8080","8880","2052","2082","2086","2095"];if(!isValidIPv4(s)&&"-1"==n)for(let t of a)if(s.includes(t)){n=t;break}"-1"==n&&(n="80");let i=t,c=path;return`${atob(啥啥啥_写的这是啥啊)}://${e}@${s}:${n+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT0mdHlwZT13cyZob3N0PQ==")+i}&path=${encodeURIComponent(c)}#${encodeURIComponent(r+"")}`})).join("\n")}const c=[...new Set(addresses)].map((s=>{let n="-1",r=s;const o=r.match(l);if(o)s=o[1],n=o[2]||n,r=o[3]||s;else{if(s.includes(":")&&s.includes("#")){const t=s.split(":");s=t[0];const e=t[1].split("#");n=e[0],r=e[1]}else if(s.includes(":")){const t=s.split(":");s=t[0],n=t[1]}else if(s.includes("#")){const t=s.split("#");s=t[0],r=t[1]}r.includes(":")&&(r=r.split(":")[0])}if(!isValidIPv4(s)&&"-1"==n)for(let t of httpsPorts)if(s.includes(t)){n=t;break}"-1"==n&&(n="443");let a=t,i=path,c="";const d=proxyIPPool.find((t=>t.includes(s)));d&&(i+=`&proxyip=${d}`),proxyhosts.length>0&&a.includes(".workers.dev")&&(i=`/${a}${i}`,a=proxyhosts[Math.floor(Math.random()*proxyhosts.length)],c=" 已启用临时域名中转服务，请尽快绑定自定义域！");return`${atob(啥啥啥_写的这是啥啊)}://${e}@${s}:${n+atob("P2VuY3J5cHRpb249bm9uZSZzZWN1cml0eT10bHMmc25pPQ==")+a}&fp=random&type=ws&host=${a}&path=${encodeURIComponent(i)}#${encodeURIComponent(r+c)}`})).join("\n");let d=c;return"true"==s&&(d+=`\n${i}`),link.length>0&&(d+="\n"+link.join("\n")),btoa(d)}async function 整理(t){var e=t.replace(/[	|"'\r\n]+/g,",").replace(/,+/g,",");","==e.charAt(0)&&(e=e.slice(1)),","==e.charAt(e.length-1)&&(e=e.slice(0,e.length-1));return e.split(",")}async function sendMessage(t,e,s=""){if(BotToken&&ChatID)try{let n="";const r=await fetch(`http://ip-api.com/json/${e}?lang=zh-CN`);if(r.ok){const o=await r.json();n=`${t}\nIP: ${e}\n国家: ${o.country}\n<tg-spoiler>城市: ${o.city}\n组织: ${o.org}\nASN: ${o.as}\n${s}`}else n=`${t}\nIP: ${e}\n<tg-spoiler>${s}`;const o=`https://api.telegram.org/bot${BotToken}/sendMessage?chat_id=${ChatID}&parse_mode=HTML&text=${encodeURIComponent(n)}`;return fetch(o,{method:"GET",headers:{Accept:"text/html,application/xhtml+xml,application/xml;","Accept-Encoding":"gzip, deflate, br","User-Agent":"Mozilla/5.0 Chrome/90.0.4430.72"}})}catch(t){console.error("Error sending message:",t)}}function isValidIPv4(t){return/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(t)}function 生成动态UUID(t){const e=new Date(2007,6,7,更新时间,0,0),s=864e5*有效时间;function 生成UUID(t){const e=(new TextEncoder).encode(t);return crypto.subtle.digest("SHA-256",e).then((t=>{const e=Array.from(new Uint8Array(t)).map((t=>t.toString(16).padStart(2,"0"))).join("");return`${e.substr(0,8)}-${e.substr(8,4)}-4${e.substr(13,3)}-${(63&parseInt(e.substr(16,2),16)|128).toString(16)}${e.substr(18,2)}-${e.substr(20,12)}`}))}const n=function(){const t=new Date,n=new Date(t.getTime()+288e5),r=Number(n)-Number(e);return Math.ceil(r/s)}(),r=new Date(e.getTime()+n*s),o=生成UUID(t+n),a=生成UUID(t+(n-1)),l=`到期时间(UTC): ${new Date(r.getTime()-288e5).toISOString().slice(0,19).replace("T"," ")} (UTC+8): ${r.toISOString().slice(0,19).replace("T"," ")}\n`;return Promise.all([o,a,l])}async function KV(t,e,s="/ADD.txt"){try{if("POST"===t.method){if(!e.KV)return new Response("未绑定KV空间",{status:400});try{const n=await t.text();return await e.KV.put(s,n),new Response("保存成功")}catch(t){return console.error("保存KV时发生错误:",t),new Response("保存失败: "+t.message,{status:500})}}let n="",r=!!e.KV;if(r)try{n=await e.KV.get(s)||""}catch(t){console.error("读取KV时发生错误:",t),n="读取数据时发生错误: "+t.message}const o=`\n\t\t<!DOCTYPE html>\n\t\t<html>\n\t\t<head>\n\t\t\t<title>优选订阅列表</title>\n\t\t\t<meta charset="utf-8">\n\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1">\n\t\t\t<style>\n\t\t\t\tbody {\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\tpadding: 15px; /* 调整padding */\n\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\tfont-size: 13px; /* 设置全局字体大小 */\n\t\t\t\t}\n\t\t\t\t.editor-container {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\tmax-width: 100%;\n\t\t\t\t\tmargin: 0 auto;\n\t\t\t\t}\n\t\t\t\t.editor {\n\t\t\t\t\twidth: 100%;\n\t\t\t\t\theight: 520px; /* 调整高度 */\n\t\t\t\t\tmargin: 15px 0; /* 调整margin */\n\t\t\t\t\tpadding: 10px; /* 调整padding */\n\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\tborder: 1px solid #ccc;\n\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\tfont-size: 13px;\n\t\t\t\t\tline-height: 1.5;\n\t\t\t\t\toverflow-y: auto;\n\t\t\t\t\tresize: none;\n\t\t\t\t}\n\t\t\t\t.save-container {\n\t\t\t\t\tmargin-top: 8px; /* 调整margin */\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tgap: 10px; /* 调整gap */\n\t\t\t\t}\n\t\t\t\t.save-btn, .back-btn {\n\t\t\t\t\tpadding: 6px 15px; /* 调整padding */\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tborder: none;\n\t\t\t\t\tborder-radius: 4px;\n\t\t\t\t\tcursor: pointer;\n\t\t\t\t}\n\t\t\t\t.save-btn {\n\t\t\t\t\tbackground: #4CAF50;\n\t\t\t\t}\n\t\t\t\t.save-btn:hover {\n\t\t\t\t\tbackground: #45a049;\n\t\t\t\t}\n\t\t\t\t.back-btn {\n\t\t\t\t\tbackground: #666;\n\t\t\t\t}\n\t\t\t\t.back-btn:hover {\n\t\t\t\t\tbackground: #555;\n\t\t\t\t}\n\t\t\t\t.save-status {\n\t\t\t\t\tcolor: #666;\n\t\t\t\t}\n\t\t\t</style>\n\t\t</head>\n\t\t<body>\n\t\t\t################################################################<br>\n\t\t\t${FileName} 优选订阅列表:<br>\n\t\t\t---------------------------------------------------------------<br>\n\t\t\t<div class="editor-container">\n\t\t\t\t${r?`\n\t\t\t\t<textarea class="editor" \n\t\t\t\t\tplaceholder="${decodeURIComponent(atob("QUREJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCnZpc2EuY24lMjMlRTQlQkMlOTglRTklODAlODklRTUlOUYlOUYlRTUlOTAlOEQKMTI3LjAuMC4xJTNBMTIzNCUyM0NGbmF0CiU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MyUyM0lQdjYKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QQolRTYlQUYlOEYlRTglQTElOEMlRTQlQjglODAlRTQlQjglQUElRTUlOUMlQjAlRTUlOUQlODAlRUYlQkMlOEMlRTYlQTAlQkMlRTUlQkMlOEYlRTQlQjglQkElMjAlRTUlOUMlQjAlRTUlOUQlODAlM0ElRTclQUIlQUYlRTUlOEYlQTMlMjMlRTUlQTQlODclRTYlQjMlQTgKSVB2NiVFNSU5QyVCMCVFNSU5RCU4MCVFOSU5QyU4MCVFOCVBNiU4MSVFNyU5NCVBOCVFNCVCOCVBRCVFNiU4QiVBQyVFNSU4RiVCNyVFNiU4QiVBQyVFOCVCNSVCNyVFNiU5RCVBNSVFRiVCQyU4QyVFNSVBNiU4MiVFRiVCQyU5QSU1QjI2MDYlM0E0NzAwJTNBJTNBJTVEJTNBMjA1MwolRTclQUIlQUYlRTUlOEYlQTMlRTQlQjglOEQlRTUlODYlOTklRUYlQkMlOEMlRTklQkIlOTglRTglQUUlQTQlRTQlQjglQkElMjA0NDMlMjAlRTclQUIlQUYlRTUlOEYlQTMlRUYlQkMlOEMlRTUlQTYlODIlRUYlQkMlOUF2aXNhLmNuJTIzJUU0JUJDJTk4JUU5JTgwJTg5JUU1JTlGJTlGJUU1JTkwJThECgoKQUREQVBJJUU3JUE0JUJBJUU0JUJFJThCJUVGJUJDJTlBCmh0dHBzJTNBJTJGJTJGcmF3LmdpdGh1YnVzZXJjb250ZW50LmNvbSUyRmNtbGl1JTJGV29ya2VyVmxlc3Myc3ViJTJGcmVmcyUyRmhlYWRzJTJGbWFpbiUyRmFkZHJlc3Nlc2FwaS50eHQKCiVFNiVCMyVBOCVFNiU4NCU4RiVFRiVCQyU5QUFEREFQSSVFNyU5QiVCNCVFNiU4RSVBNSVFNiVCNyVCQiVFNSU4QSVBMCVFNyU5QiVCNCVFOSU5MyVCRSVFNSU4RCVCMyVFNSU4RiVBRg=="))}"\n\t\t\t\t\tid="content">${n}</textarea>\n\t\t\t\t<div class="save-container">\n\t\t\t\t\t<button class="back-btn" onclick="goBack()">返回配置页</button>\n\t\t\t\t\t<button class="save-btn" onclick="saveContent()">保存</button>\n\t\t\t\t\t<span class="save-status" id="saveStatus"></span>\n\t\t\t\t</div>\n\t\t\t\t<br>\n\t\t\t\t################################################################<br>\n\t\t\t\t${cmad}\n\t\t\t\t`:"<p>未绑定KV空间</p>"}\n\t\t\t</div>\n\n\t\t\t<script>\n\t\t\tif (document.querySelector('.editor')) {\n\t\t\t\tlet timer;\n\t\t\t\tconst textarea = document.getElementById('content');\n\t\t\t\tconst originalContent = textarea.value;\n\n\t\t\t\tfunction goBack() {\n\t\t\t\t\tconst currentUrl = window.location.href;\n\t\t\t\t\tconst parentUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));\n\t\t\t\t\twindow.location.href = parentUrl;\n\t\t\t\t}\n\n\t\t\t\tfunction replaceFullwidthColon() {\n\t\t\t\t\tconst text = textarea.value;\n\t\t\t\t\ttextarea.value = text.replace(/：/g, ':');\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfunction saveContent() {\n\t\t\t\t\treplaceFullwidthColon();\n\t\t\t\t\tconst newContent = textarea.value;\n\t\t\t\t\tif (newContent !== originalContent) {\n\t\t\t\t\t\tfetch(window.location.href, {\n\t\t\t\t\t\t\tmethod: 'POST',\n\t\t\t\t\t\t\tbody: newContent\n\t\t\t\t\t\t}).then(() => {\n\t\t\t\t\t\t\tconst now = new Date().toLocaleString();\n\t\t\t\t\t\t\tdocument.title = \`编辑已保存 \${now}\`;\n\t\t\t\t\t\t\tdocument.getElementById('saveStatus').textContent = \`已保存 \${now}\`;\n\t\t\t\t\t\t}).catch(error => {\n\t\t\t\t\t\t\tdocument.getElementById('saveStatus').textContent = \`保存失败: \${error.message}\`;\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\ttextarea.addEventListener('blur', saveContent);\n\t\t\t\ttextarea.addEventListener('input', () => {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\ttimer = setTimeout(saveContent, 5000);\n\t\t\t\t});\n\t\t\t}\n\t\t\t<\/script>\n\t\t</body>\n\t\t</html>\n\t\t`;return new Response(o,{headers:{"Content-Type":"text/html;charset=utf-8"}})}catch(t){return console.error("处理请求时发生错误:",t),new Response("服务器错误: "+t.message,{status:500,headers:{"Content-Type":"text/plain;charset=utf-8"}})}}
